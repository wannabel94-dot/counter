<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC Cash Counter</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#111" />

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #fff;
    margin: 0;
    padding: 20px;
    text-align: center;
  }
  h1 { font-size: 2.5rem; }
  h2 { font-size: 1.8rem; }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.8);
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal.active { display: flex; }

  .panel {
    background: #222;
    padding: 20px;
    border-radius: 12px;
    width: 280px;
  }

  .display {
    font-size: 2rem;
    background: #000;
    padding: 10px;
    margin-bottom: 10px;
    text-align: right;
  }

  .keys {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  button {
    font-size: 1.4rem;
    padding: 12px;
    border: none;
    border-radius: 8px;
  }

  .ok { background: #4caf50; color: #000; grid-column: span 2; }
  .clear { background: #f44336; color: #000; }
</style>
</head>

<body>
<h1 id="status">Ready</h1>
<h2>Total: €<span id="total">0</span></h2>

<button onclick="reset()">Reset</button>

<!-- Keypad Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="display" id="display">0</div>
    <div class="keys">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>
      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>
      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>
      <button onclick="press(0)">0</button>
      <button class="clear" onclick="clearInput()">C</button>
      <button class="ok" onclick="confirmAmount()">OK</button>
    </div>
  </div>
</div>

<script>
const TOTAL_KEY = "cash_total";
const LAST_TIME = "last_scan";
let mode = null;
let input = "";

const params = new URLSearchParams(location.search);
const action = params.get("action");

let total = Number(localStorage.getItem(TOTAL_KEY) || 0);
document.getElementById("total").textContent = total;

// Prevent double scans
const now = Date.now();
const last = Number(localStorage.getItem(LAST_TIME) || 0);
if (now - last < 1500) {
  document.getElementById("status").textContent = "Ignored";
} else if (action) {
  localStorage.setItem(LAST_TIME, now);
  mode = action;
  openModal();
}

function openModal() {
  input = "";
  updateDisplay();
  document.getElementById("modal").classList.add("active");
  document.getElementById("status").textContent =
    mode === "add" ? "Add amount" : "Subtract amount";
}

function press(n) {
  input += n;
  updateDisplay();
}

function clearInput() {
  input = "";
  updateDisplay();
}

function updateDisplay() {
  document.getElementById("display").textContent = input || "0";
}

function confirmAmount() {
  const amount = Number(input || 0);
  if (!amount) return;

  total += mode === "add" ? amount : -amount;
  localStorage.setItem(TOTAL_KEY, total);
  document.getElementById("total").textContent = total;

  document.getElementById("modal").classList.remove("active");
  document.getElementById("status").textContent =
    `${mode === "add" ? "+" : "−"} €${amount}`;
}

function reset() {
  if (!confirm("Reset total?")) return;
  localStorage.clear();
  location.reload();
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
