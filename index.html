<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC Cash Counter</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b3d1c">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h2 { font-size: 1.8rem; margin-bottom: 10px; }

#lastChange {
  font-size: 2.5rem;
  margin-bottom: 15px;
  font-weight: bold;
  opacity: 0;
  transition: opacity 0.5s ease;
}

@keyframes flash {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.3); }
  100% { opacity: 0; transform: scale(1); }
}

button { cursor: pointer; }
button.reset, button.undo {
  margin: 5px;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 10px;
  border: none;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal.active { display: flex; }

/* Calculator panel */
.panel {
  padding: 20px;
  border-radius: 16px;
  width: 280px;
  background-color: rgba(20,20,20,0.95);
}

/* Display */
.display {
  font-size: 2.2rem;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.display span.prefix {
  margin-right: auto;
  font-size: 2.2rem;
}

.display.add { background: #dfffdc; color: #0b3d1c; }
.display.sub { background: #ffdcdc; color: #8a1c1c; }

.keys {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.keys button {
  font-size: 1.4rem;
  padding: 14px;
  border: none;
  border-radius: 10px;
  background: #1b5e20;
  color: #e8f5e9;
}

.ok { grid-column: span 2; font-weight: bold; }
.ok.add { background: #4caf50; color: #000; }
.ok.sub { background: #f44336; color: #000; }

.clear { background: #2e7d32; color: #fff; }
.panel.sub .keys button { background: #ef5350; color: #000; }
.panel.sub .keys button.clear { background: #e53935; color: #fff; }

/* Transaction log table */
table {
  margin: 20px auto;
  border-collapse: collapse;
  width: 90%;
  max-width: 500px;
}
th, td {
  border: 1px solid #fff;
  padding: 8px 12px;
  text-align: center;
}
th { background-color: #222; }
</style>
</head>

<body>

<div id="lastChange"></div>
<h2>Total: <span id="total">0</span></h2>

<button class="undo" onclick="undo()">Undo</button>
<button class="reset" onclick="reset()">Reset</button>

<table id="logTable">
  <thead>
    <tr>
      <th>Time</th>
      <th>Change</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal" id="modal">
  <div class="panel" id="panel">
    <div class="display" id="display">
      <span class="prefix">+</span>
      <span class="value">0</span>
    </div>
    <div class="keys">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>
      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>
      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>
      <button onclick="press(0)">0</button>
      <button class="clear" onclick="clearInput()">C</button>
      <button class="ok add" id="okButton" onclick="confirmAmount()">OK</button>
    </div>
  </div>
</div>

<script>
const TOTAL_KEY = "cash_total";
const LAST_SCAN = "last_scan";
const LAST_CHANGE_KEY = "last_change";
const LOG_KEY = "transaction_log";

let input = "";
let mode = "add";

let total = Number(localStorage.getItem(TOTAL_KEY) || 0);
document.getElementById("total").textContent = total;

let transactionLog = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
updateLogTable();

const params = new URLSearchParams(location.search);
const action = params.get("action");
const now = Date.now();
const last = Number(localStorage.getItem(LAST_SCAN) || 0);

if (action && now - last > 1500) {
  localStorage.setItem(LAST_SCAN, now);
  mode = action;
  openModal();
}

function openModal() {
  input = "";
  updateDisplay();
  document.getElementById("modal").classList.add("active");
}

function press(n) {
  input += n;
  updateDisplay();
}

function clearInput() {
  input = "";
  updateDisplay();
}

function updateDisplay() {
  const display = document.getElementById("display");
  display.className = "display " + mode;
  display.querySelector(".prefix").textContent = mode === "add" ? "+" : "-";
  display.querySelector(".value").textContent = input || "0";
}

function formatDate(d) {
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getFullYear()).slice(-2)} - ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function confirmAmount() {
  const amount = Number(input || 0);
  if (!amount) return;

  const delta = mode === "add" ? amount : -amount;
  if (total + delta < 0) {
    alert("Cannot subtract more than current total");
    closeModal();
    return;
  }

  total += delta;
  localStorage.setItem(TOTAL_KEY, total);
  localStorage.setItem(LAST_CHANGE_KEY, delta);

  transactionLog.unshift({ delta, total, time: formatDate(new Date()) });
  localStorage.setItem(LOG_KEY, JSON.stringify(transactionLog));

  document.getElementById("total").textContent = total;
  showLastChange(delta);
  updateLogTable();
  closeModal();
}

function showLastChange(delta) {
  const el = document.getElementById("lastChange");
  el.textContent = (delta > 0 ? "+" : "") + delta;
  el.style.color = delta > 0 ? "#4caf50" : "#f44336";
  el.style.opacity = 1;
  el.style.animation = "flash 2s forwards";
  setTimeout(() => el.style.opacity = 0, 2000);
}

function undo() {
  const last = Number(localStorage.getItem(LAST_CHANGE_KEY) || 0);
  if (!last) return;

  total -= last;
  localStorage.setItem(TOTAL_KEY, total);
  document.getElementById("total").textContent = total;

  transactionLog.shift();
  localStorage.setItem(LOG_KEY, JSON.stringify(transactionLog));
  localStorage.removeItem(LAST_CHANGE_KEY);
  updateLogTable();
}

function reset() {
  if (!confirm("Reset total?")) return;
  localStorage.clear();
  location.reload();
}

function updateLogTable() {
  const tbody = document.querySelector("#logTable tbody");
  tbody.innerHTML = "";

  transactionLog.forEach(t => {
    const tr = document.createElement("tr");

    const tdTime = document.createElement("td");
    tdTime.textContent = t.time;

    const tdDelta = document.createElement("td");
    tdDelta.textContent = (t.delta > 0 ? "+" : "") + t.delta;
    tdDelta.style.color = t.delta > 0 ? "#4caf50" : "#f44336";
    tdDelta.style.fontWeight = "bold";

    const tdTotal = document.createElement("td");
    tdTotal.textContent = t.total;

    tr.append(tdTime, tdDelta, tdTotal);
    tbody.appendChild(tr);
  });
}

function closeModal() {
  document.getElementById("modal").classList.remove("active");
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
