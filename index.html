<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC Cash Counter</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b3d1c">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h2 {
  font-size: 1.8rem;
  margin-bottom: 10px;
}

#lastChange {
  font-size: 2.4rem;
  font-weight: bold;
  margin-bottom: 12px;
  opacity: 0;
}

button {
  margin: 5px;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.panel {
  width: 280px;
  padding: 20px;
  border-radius: 16px;
  background: #141414;
}

.display {
  display: flex;
  font-size: 2.2rem;
  font-weight: bold;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.display.add {
  background: #dfffdc;
  color: #0b3d1c;
}

.display.sub {
  background: #ffdcdc;
  color: #8a1c1c;
}

.prefix {
  margin-right: auto;
}

.keys {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.keys button {
  font-size: 1.4rem;
  padding: 14px;
  border-radius: 10px;
  background: #1b5e20;
  color: #fff;
}

.panel.sub .keys button {
  background: #ef5350;
  color: #000;
}

.ok {
  grid-column: span 2;
  font-weight: bold;
}

.clear {
  background: #2e7d32;
}

table {
  margin: 20px auto;
  width: 90%;
  max-width: 520px;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #444;
  padding: 8px;
}

th {
  background: #222;
}
</style>
</head>

<body>

<div id="lastChange"></div>
<h2>Total: <span id="total">0</span></h2>

<button onclick="undo()">Undo</button>
<button onclick="reset()">Reset</button>

<table id="logTable">
  <thead>
    <tr>
      <th>Date / Time</th>
      <th>Change</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal" id="modal">
  <div class="panel" id="panel">
    <div class="display" id="display">
      <span class="prefix">+</span>
      <span class="value">0</span>
    </div>

    <div class="keys">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>
      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>
      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>
      <button onclick="press(0)">0</button>
      <button class="clear" onclick="clearInput()">C</button>
      <button class="ok" onclick="confirmAmount()">OK</button>
    </div>
  </div>
</div>

<script>
const TOTAL_KEY = "total";
const LOG_KEY = "log";
const LAST_KEY = "last";
let total = Number(localStorage.getItem(TOTAL_KEY)) || 0;
let log = JSON.parse(localStorage.getItem(LOG_KEY)) || [];
let input = "";
let mode = "add";

document.getElementById("total").textContent = total;
renderLog();

const params = new URLSearchParams(location.search);
if (params.get("action")) {
  mode = params.get("action");
  openModal();
}

function openModal() {
  input = "";
  updateDisplay();
  document.getElementById("modal").classList.add("active");
}

function press(n) {
  input += n;
  updateDisplay();
}

function clearInput() {
  input = "";
  updateDisplay();
}

function updateDisplay() {
  const d = document.getElementById("display");
  d.className = "display " + mode;
  d.querySelector(".prefix").textContent = mode === "add" ? "+" : "-";
  d.querySelector(".value").textContent = input || "0";
}

function confirmAmount() {
  const amount = Number(input);
  if (!amount) return;

  if (mode === "sub" && amount > total) {
    alert("Not enough balance");
    closeModal();
    return;
  }

  const delta = mode === "add" ? amount : -amount;
  total += delta;

  localStorage.setItem(TOTAL_KEY, total);
  localStorage.setItem(LAST_KEY, delta);

  log.unshift({
    time: formatDate(new Date()),
    delta,
    total
  });

  localStorage.setItem(LOG_KEY, JSON.stringify(log));
  document.getElementById("total").textContent = total;
  showLast(delta);
  renderLog();
  closeModal();
}

function showLast(delta) {
  const el = document.getElementById("lastChange");
  el.textContent = (delta > 0 ? "+" : "") + delta;
  el.style.color = delta > 0 ? "#4caf50" : "#f44336";
  el.style.opacity = 1;
  setTimeout(() => el.style.opacity = 0, 2000);
}

function undo() {
  const delta = Number(localStorage.getItem(LAST_KEY));
  if (!delta) return;

  total -= delta;
  if (total < 0) total = 0;

  log.shift();
  localStorage.setItem(TOTAL_KEY, total);
  localStorage.setItem(LOG_KEY, JSON.stringify(log));
  localStorage.removeItem(LAST_KEY);

  document.getElementById("total").textContent = total;
  renderLog();
}

function reset() {
  if (!confirm("Reset everything?")) return;
  localStorage.clear();
  location.reload();
}

function renderLog() {
  const tbody = document.querySelector("#logTable tbody");
  tbody.innerHTML = "";

  log.forEach(t => {
    const tr = document.createElement("tr");

    const tdTime = document.createElement("td");
    tdTime.textContent = t.time;

    const tdDelta = document.createElement("td");
    tdDelta.textContent = (t.delta > 0 ? "+" : "") + t.delta;
    tdDelta.style.color = t.delta > 0 ? "#4caf50" : "#f44336";
    tdDelta.style.fontWeight = "bold";

    const tdTotal = document.createElement("td");
    tdTotal.textContent = t.total;

    tr.append(tdTime, tdDelta, tdTotal);
    tbody.appendChild(tr);
  });
}

function formatDate(d) {
  return `${String(d.getDate()).padStart(2,"0")}/${
    String(d.getMonth()+1).padStart(2,"0")
  }/${String(d.getFullYear()).slice(-2)} - ${
    String(d.getHours()).padStart(2,"0")
  }:${String(d.getMinutes()).padStart(2,"0")}`;
}

function closeModal() {
  document.getElementById("modal").classList.remove("active");
}
</script>

</body>
</html>
