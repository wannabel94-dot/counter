<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC Cash Counter</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b3d1c">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h2 { font-size: 1.8rem; margin-bottom: 10px; }
#lastChange {
  font-size: 1.6rem;
  margin-bottom: 15px;
  font-weight: bold;
  opacity: 0;
  transition: opacity 0.5s ease;
}

/* Flash animation for last transaction */
@keyframes flash {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
  100% { opacity: 0; transform: scale(1); }
}

button { cursor: pointer; }
button.reset, button.undo {
  margin: 5px;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 10px;
  border: none;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal.active { display: flex; }

/* Calculator panel */
.panel {
  padding: 20px;
  border-radius: 16px;
  width: 280px;
  transition: box-shadow 0.2s ease;
}

/* Display */
.display {
  font-size: 2.2rem;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.display span.prefix { margin-right: auto; font-size: 2.2rem; font-weight: bold; }
.display.add { background: #dfffdc; color: #0b3d1c; }
.display.sub { background: #ffdcdc; color: #8a1c1c; }

.keys {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.keys button {
  font-size: 1.4rem;
  padding: 14px;
  border: none;
  border-radius: 10px;
  background: #1b5e20;
  color: #e8f5e9;
  transition: background 0.15s ease, transform 0.05s ease;
}
.keys button:active { transform: scale(0.96); }

.ok { grid-column: span 2; font-weight: bold; }
.ok.add { background: #4caf50; color: #000; }
.ok.sub { background: #f44336; color: #000; }

.clear { background: #2e7d32; color: #fff; }
.panel.sub .keys button { background: #ef5350; color: #000; }
.panel.sub .keys button.clear { background: #e53935; color: #fff; }

/* Transaction log table */
table {
  margin: 20px auto;
  border-collapse: collapse;
  width: 90%;
  max-width: 400px;
}
th, td {
  border: 1px solid #fff;
  padding: 8px 12px;
  text-align: center;
}
th { background-color: #222; }
tr:nth-child(even) { background-color: #1a1a1a; }
</style>
</head>

<body>

<div id="lastChange"></div>
<h2>Total: <span id="total">0</span></h2>

<button class="undo" onclick="undo()">Undo</button>
<button class="reset" onclick="reset()">Reset</button>

<!-- Transaction log table -->
<table id="logTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Change</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    <!-- Filled dynamically -->
  </tbody>
</table>

<!-- Calculator Modal -->
<div class="modal" id="modal">
  <div class="panel" id="panel">
    <div class="display" id="display">
      <span class="prefix">+</span>
      <span class="value">0</span>
    </div>
    <div class="keys">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>
      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>
      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>
      <button onclick="press(0)">0</button>
      <button class="clear" onclick="clearInput()">C</button>
      <button class="ok add" id="okButton" onclick="confirmAmount()">OK</button>
    </div>
  </div>
</div>

<script>
const TOTAL_KEY = "cash_total";
const LAST_SCAN = "last_scan";
const LAST_CHANGE_KEY = "last_change";
const LOG_KEY = "transaction_log";

let input = "";
let mode = "add";

// Load total
let total = Number(localStorage.getItem(TOTAL_KEY) || 0);
document.getElementById("total").textContent = total;

// Load last change
let lastChange = Number(localStorage.getItem(LAST_CHANGE_KEY) || 0);

// Load transaction log
let transactionLog = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
updateLogTable();

// NFC action
const params = new URLSearchParams(location.search);
const action = params.get("action");
const now = Date.now();
const last = Number(localStorage.getItem(LAST_SCAN) || 0);

if(action && now - last > 1500){
  localStorage.setItem(LAST_SCAN, now);
  mode = action;
  openModal();
}

function openModal(){
  input="";
  updateDisplay();
  const modal = document.getElementById("modal");
  const display = document.getElementById("display");
  const okButton = document.getElementById("okButton");
  const panel = document.getElementById("panel");

  modal.classList.add("active");

  if(mode==="add"){
    display.classList.add("add"); display.classList.remove("sub");
    okButton.classList.add("add"); okButton.classList.remove("sub");
    panel.classList.add("add"); panel.classList.remove("sub");
    panel.style.boxShadow="0 0 60px rgba(76,175,80,0.8)";
  } else {
    display.classList.add("sub"); display.classList.remove("add");
    okButton.classList.add("sub"); okButton.classList.remove("add");
    panel.classList.add("sub"); panel.classList.remove("add");
    panel.style.boxShadow="0 0 60px rgba(244,67,54,0.8)";
  }
}

function press(n){ input+=n; updateDisplay(); }
function clearInput(){ input=""; updateDisplay(); }
function updateDisplay(){
  const display=document.getElementById("display");
  const prefixSpan=display.querySelector(".prefix");
  const valueSpan=display.querySelector(".value");
  prefixSpan.textContent=mode==="add"?"+":"-";
  valueSpan.textContent=input||"0";
}

function confirmAmount(){
  const amount=Number(input||0);
  if(!amount) return;

  let delta = mode==="add"? amount : -amount;
  if(total + delta < 0) delta = -total;
  total += delta;
  localStorage.setItem(TOTAL_KEY,total);
  localStorage.setItem(LAST_CHANGE_KEY, delta);
  lastChange = delta;

  document.getElementById("total").textContent = total;
  showLastChange(delta);

  // Add to log
  transactionLog.push({delta, total});
  localStorage.setItem(LOG_KEY, JSON.stringify(transactionLog));
  updateLogTable();

  if(navigator.vibrate) navigator.vibrate(40);
  document.getElementById("modal").classList.remove("active");

  const flashColor = delta > 0 ? "#1b5e20": "#a00000";
  document.body.style.background = flashColor;
  setTimeout(()=>document.body.style.background="#111",150);
}

function showLastChange(delta){
  const lastEl=document.getElementById("lastChange");
  lastEl.textContent = (delta>0?"+":"") + delta;
  lastEl.style.color = delta>0?"#4caf50":"#f44336";
  lastEl.style.opacity=1;
  lastEl.style.animation="flash 1.5s forwards";
  setTimeout(()=>{ lastEl.style.opacity=0; },1500);
}

function undo(){
  const last = Number(localStorage.getItem(LAST_CHANGE_KEY)||0);
  if(!last) return;

  total -= last;
  if(total<0) total=0;
  localStorage.setItem(TOTAL_KEY,total);
  document.getElementById("total").textContent=total;

  lastChange=0;
  localStorage.removeItem(LAST_CHANGE_KEY);
  document.getElementById("lastChange").style.opacity=0;

  // Remove last log entry
  if(transactionLog.length>0) transactionLog.pop();
  localStorage.setItem(LOG_KEY, JSON.stringify(transactionLog));
  updateLogTable();
}

function reset(){
  if(!confirm("Reset total?")) return;
  localStorage.clear();
  transactionLog=[];
  location.reload();
}

function updateLogTable(){
  const tbody = document.getElementById("logTable").querySelector("tbody");
  tbody.innerHTML="";
  transactionLog.forEach((t,i)=>{
    const tr=document.createElement("tr");
    const tdIndex=document.createElement("td"); tdIndex.textContent=i+1;
    const tdDelta=document.createElement("td"); tdDelta.textContent=(t.delta>0?"+":"") + t.delta;
    tdDelta.style.color = t.delta>0 ? "#4caf50" : "#f44336";
    const tdTotal=document.createElement("td"); tdTotal.textContent = t.total;
    tr.appendChild(tdIndex); tr.appendChild(tdDelta); tr.appendChild(tdTotal);
    tbody.appendChild(tr);
  });
}

// Optional: PWA Service Worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
